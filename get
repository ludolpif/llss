#!/bin/sh
#
# This file is part of LLSS.
#
# LLSS is free software: you can redistribute it and/or modify it under the terms of the
# Affero GNU General Public License as published by the Free Software Foundation,
# either version 3 of the License, or (at your option) any later version.
#
# LLSS is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
# without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with LLSS.
# If not, see <https://www.gnu.org/licenses/>. See LICENSE file at root of this git repo.
#
# Copyright 2025 ludolpif <ludolpif@gmail.com>
#
BUILDDEP_VERSION=0.2.0.0

build_dep() {
	prettyos=$(prettyos)
	set -xe
	zipname=build-dep-${BUILDDEP_VERSION}-$prettyos-$1.zip
	url=https://ludolpif.fr/pub/llss/artifacts/$zipname
	[ -f $zipname ] || curl -o $zipname $url
	unzip -q $zipname
	rm -f $zipname
}
cflags() {
	case "$1" in
		Debug)          solution="-ggdb3 -O0 -D_DEBUG" ;;
		Release)        solution="-g -O2 -DNDEBUG" ;;
		# removed RelWithDebInfo, we always can strip debug symbols after build
		*) echo "Bad BUILD_TYPE, should be Debug or Release" >&2; exit 1 ;;
	esac
	echo $solution # -flto=auto (is very slow)
}
ldflags() {
	solution=""
	echo $solution
}
name() {
	grep "define APP_METADATA_NAME_STRING" include/metadata.h | cut -d'"' -f2
}
prettyos() {
	case $(uname -s) in
		Linux)      os="$( . /etc/os-release && echo $ID-$VERSION_CODENAME )" ;;
		Darwin)     os="MacOS" ;;
		*)          echo "Unknown platform" >&2
	esac
	echo $os
}
version() {
	grep "define APP_VERSION_STR" include/metadata.h | cut -d'"' -f2
}
case $1 in
	--build-dep) build_dep $2 ;;
	--cflags) cflags $2 ;;
	--ldflags) ldflags $2 ;;
	--name) name $2 ;;
	--prettyos) prettyos $2 ;;
	--version) version $2 ;;
	*) echo "Usage $0 (--build-dep|--cflags|--ldflags|--prettyos|--name|--version) (Debug|Release)" >&2 ;;
esac
